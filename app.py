# app.py
import os, re, json, requests
from datetime import datetime
from flask import Flask, request, jsonify, send_from_directory

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ENV
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BOT_TOKEN    = os.getenv("BOT_TOKEN", "")
SECRET_TOKEN = os.getenv("SECRET_TOKEN", "SabinaSecret")

BASE_URL       = os.getenv("BASE_URL", "https://sabina-energy-hd-bot.onrender.com")
FREE_CALC_URL  = os.getenv("FREE_CALC_URL",  "https://human-design.space/dizajn-cheloveka-raschet-karty/#/")
PAID_CALC_URL  = os.getenv("PAID_CALC_URL",  "https://human-design.space/dizajn-cheloveka-raschet-karty/#/")
VIDEO_URL      = os.getenv("VIDEO_URL",      "https://t.me/your_channel/123")

# Ğ’ĞµĞ±-Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ»Ğ¸Ğ´Ğ° Ğ² Google Sheets (Apps Script Ğ¸Ğ»Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°) â€“ ÑĞ¼. Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ½Ğ¸Ğ¶Ğµ.
LEAD_WEBHOOK_URL = os.getenv("LEAD_WEBHOOK_URL", "")  # Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾

TG_API = f"https://api.telegram.org/bot{BOT_TOKEN}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Flask
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = Flask(__name__, static_folder="webapp", static_url_path="/hd")

# ĞŸĞ°Ğ¿ĞºĞ° Ñ Ğ¼ĞµĞ´Ğ¸Ğ°ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ°Ğ¼Ğ¸ (Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² ./static/cards/)
CARDS_DIR = "static/cards"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def tg(method: str, **params):
    try:
        r = requests.post(f"{TG_API}/{method}", json=params, timeout=15)
        return r.json()
    except Exception as e:
        return {"ok": False, "error": str(e)}

def reply_kb(rows):
    return {"keyboard": rows, "resize_keyboard": True, "is_persistent": True}

def inline_btn(text, url=None, data=None):
    b = {"text": text}
    if url:  b["url"] = url
    if data: b["callback_data"] = data
    return b

def send_photo_if_exists(chat_id: int, filename: str, caption: str = None):
    """
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾, ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² ./static/cards/, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾.
    ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ‚Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘ÑˆÑŒ ÑĞ°Ğ¼Ğ° (ÑĞ¼. TYPE_CARD / PROFILE_CARD Ğ½Ğ¸Ğ¶Ğµ).
    """
    path = os.path.join(CARDS_DIR, filename)
    if os.path.exists(path):
        # Telegram Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ URL, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¾Ñ‚Ğ´Ğ°Ğ´Ğ¸Ğ¼ Ñ‡ĞµÑ€ĞµĞ· Ğ½Ğ°Ñˆ ÑĞµÑ€Ğ²ĞµÑ€
        photo_url = f"{BASE_URL}/cards/{filename}"
        tg("sendPhoto", chat_id=chat_id, photo=photo_url, caption=caption, parse_mode="HTML")

def email_valid(s: str) -> bool:
    return bool(re.match(r"^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$", s.strip()))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ABOUT_HD = [
    "âœ¨ <b>Human Design</b> â€” ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€Ğ¾ Ğ¶Ğ¸Ğ·Ğ½ÑŒ Ğ² ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğ¸ ÑĞ¾ ÑĞ²Ğ¾ĞµĞ¹ Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´Ğ¾Ğ¹.",
    "ğŸ”­ Ğ¡Ğ¸Ğ½Ñ‚ĞµĞ· Ğ°ÑÑ‚Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸, Ğ˜-Ğ¦Ğ·Ğ¸Ğ½, ĞšĞ°Ğ±Ğ±Ğ°Ğ»Ñ‹, Ñ‡Ğ°ĞºÑ€Ğ¾Ğ²Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸ Ğ¸Ğ´ĞµĞ¸ Ğ¾ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ¸Ğ½Ğ¾.",
    "ğŸ¯ ĞšĞ»ÑÑ‡: <b>ÑĞ»ĞµĞ´ÑƒĞ¹ Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ¸ ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ</b> â€” Ñ‚Ğ°Ğº ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ»Ğ¸ÑˆĞ½ĞµĞµ Ğ½Ğ°Ğ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ Â«ÑĞ²Ğ¾Ğ¸Â» Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸."
]

ABOUT_TYPES_SHORT = [
    "ğŸ“š <b>Ğ¢Ğ¸Ğ¿Ñ‹ (5)</b>:",
    "â€¢ ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€ â€” Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€ÑƒĞµÑ‚. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</i>.",
    "â€¢ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸Ğ· Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ°. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ°</i>.",
    "â€¢ ĞœĞ°Ğ½Ğ¸Ñ„. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµÑ‚. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ° â†’ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</i>.",
    "â€¢ ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€ â€” Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ</i>.",
    "â€¢ Ğ ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€ â€” Ğ·ĞµÑ€ĞºĞ°Ğ»Ğ¸Ñ‚ ÑÑ€ĞµĞ´Ñƒ. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ»ÑƒĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»</i>."
]

ABOUT_TYPES_LONG = [
    "âš¡ï¸ <b>ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€</b>: Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ. Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¸Ñ… â€” Ñ‚Ğ¾Ğ³Ğ´Ğ° ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ñ‚ĞµÑ‡Ñ‘Ñ‚ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾.",
    "ğŸ”‹ <b>Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€</b>: ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ğ°Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ°ĞµÑ‚ÑÑ. Ğ¡Ğ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Â«ÑƒĞ³Ñƒ/Ğ½ĞµĞ°Â» â€” Ñ‚Ğ²Ğ¾Ğ¹ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ‚Ğ¾Ñ€.",
    "ğŸš€ <b>ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€</b>: ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ½Ğ¾Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€, Ğ»ÑĞ±Ğ¸Ñ‚ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ. Ğ–Ğ´Ñ‘Ñ‚ Ğ¾Ñ‚ĞºĞ»Ğ¸Ğº, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚.",
    "ğŸ¯ <b>ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€</b>: Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ»ÑĞ´ĞµĞ¹ Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹. Ğ¡Ğ¸Ğ»Ğ° Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ.",
    "ğŸŒ™ <b>Ğ ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€</b>: Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½ Ğº ÑÑ€ĞµĞ´Ğµ; ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¶Ğ¸Ğ·Ğ½Ğ¸ = ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ. Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ â€” Ğ¿Ğ¾ÑĞ»Ğµ Ğ»ÑƒĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ°."
]

ABOUT_PROFILES_SHORT = [
    "ğŸ“– <b>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ (12)</b>: 1/3, 1/4, 2/4, 2/5, 3/5, 3/6, 4/6, 4/1, 5/1, 5/2, 6/2, 6/3."
]

PROFILE_LONG = {
    "1/3": "1/3 Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ-ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº â€” Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ + Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ñ‹ Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸. Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· Ğ¾Ğ¿Ñ‹Ñ‚Ğ°.",
    "1/4": "1/4 Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ-ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚ â€” Ğ¿Ñ€Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ±Ğ°Ğ·Ğ° + ÑĞ¸Ğ»Ğ° Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğ¹. Ğ’Ğ»Ğ¸ÑĞµÑˆÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ»Ğ¸Ğ·ĞºĞ¸Ğ¹ ĞºÑ€ÑƒĞ³.",
    "2/4": "2/4 ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº-ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚ â€” Ñ‚Ğ°Ğ»Ğ°Ğ½Ñ‚ Ğ² ÑƒĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¸, Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ· Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ. Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ¸ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°Ñ‚ÑŒ, Ğ¸ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğ° Ğ²Ğ¸Ğ´Ñƒ.",
    "2/5": "2/5 ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº-Ğ•Ñ€ĞµÑ‚Ğ¸Ğº â€” Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ…, Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ¾Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ° Â«Ğ±ĞµÑ€Ğ»Ğ¾Ğ³Ğ°Â» Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ.",
    "3/5": "3/5 ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº-Ğ•Ñ€ĞµÑ‚Ğ¸Ğº â€” ÑĞºÑĞ¿ĞµÑ€Ğ¸Ğ¼ĞµĞ½Ñ‚Ğ°Ñ‚Ğ¾Ñ€-ÑĞ¿Ğ°ÑĞ°Ñ‚ĞµĞ»ÑŒ. Ğ§ĞµÑ€ĞµĞ· Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸ÑˆÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ğ¿ÑƒÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞµĞ±Ñ Ğ¸ Ğ»ÑĞ´ĞµĞ¹.",
    "3/6": "3/6 ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº-Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ â€” ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¼ÑƒĞ´Ñ€Ğ¾Ğµ ÑĞ¾Ğ·ĞµÑ€Ñ†Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ….",
    "4/6": "4/6 ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚-Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ â€” Ğ¾Ğ¿Ğ¾Ñ€Ğ° Ğ½Ğ° ÑĞ²ÑĞ·Ğ¸ + Ğ·Ñ€ĞµĞ»Ğ°Ñ Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ñ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ¾Ğ¼. ĞĞµ ÑĞ¿ĞµÑˆĞ¸ â€” Ğ²ÑÑ‘ Ğ²Ğ¾Ğ²Ñ€ĞµĞ¼Ñ.",
    "4/1": "4/1 ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚-Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â€” Ñ€ĞµĞ´ĞºĞ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ÑĞ²ÑĞ·ĞµĞ¹ Ğ¸ Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚Ğ°. Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ ĞºÑƒÑ€Ñ.",
    "5/1": "5/1 Ğ•Ñ€ĞµÑ‚Ğ¸Ğº-Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â€” Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ Ñ€ĞµÑˆĞ°ĞµÑˆÑŒ Ğ¸Ñ…. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞ¹ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ğ»ÑĞ´ĞµĞ¹, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞ¹ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹.",
    "5/2": "5/2 Ğ•Ñ€ĞµÑ‚Ğ¸Ğº-ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº â€” Ñ‚ĞµĞ±Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ½Ğ° Â«Ğ¿Ğ¾Ğ¶Ğ°Ñ€Â», Ğ° ÑĞ¸Ğ»Ñ‹ Ñ€Ğ¾Ğ¶Ğ´Ğ°ÑÑ‚ÑÑ Ğ² ÑƒĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¸. Ğ‘Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€ÑƒĞ¹ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¸ Ğ¾Ñ‚Ğ´Ñ‹Ñ….",
    "6/2": "6/2 Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ-ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº â€” Ñ‚Ñ€Ğ¸ ÑÑ‚Ğ°Ğ¿Ğ° Ğ¶Ğ¸Ğ·Ğ½Ğ¸: Ğ¾Ğ¿Ñ‹Ñ‚, Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€. Ğ¢Ğ¸ÑˆĞ¸Ğ½Ğ° â€” Ñ‚Ğ²Ğ¾Ğ¹ Ñ€ĞµÑÑƒÑ€Ñ.",
    "6/3": "6/3 Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ-ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº â€” Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ. Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ Ğ¸ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ ÑĞ¼Ğ¾Ñ€Ğ° â€” Ğ»ÑƒÑ‡ÑˆĞ¸Ğµ ÑĞ¿ÑƒÑ‚Ğ½Ğ¸ĞºĞ¸."
}

TYPE_MINI = {
    "Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€": "âš¡ï¸ <b>ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€</b>: Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€ÑƒĞ¹ Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞ¹ â€” Ñ‚Ğ°Ğº ÑĞ¸Ğ»Ğ° Ñ‚ĞµÑ‡Ñ‘Ñ‚ Ğ¼ÑĞ³Ñ‡Ğµ.",
    "Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "ğŸ”‹ <b>Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€</b>: ÑĞ»ĞµĞ´ÑƒĞ¹ ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºÑƒ. Ğ¢Ğ¾, Ñ‡Ñ‚Ğ¾ Â«Ğ´Ğ°Â», Ğ½Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ÑĞ½ĞµÑ€Ğ³Ğ¸ĞµĞ¹.",
    "Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "ğŸš€ <b>ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€</b>: ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¸Ğº, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ. Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞ¹ Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹.",
    "Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€": "ğŸ¯ <b>ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€</b>: Ğ¸Ñ‰Ğ¸ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ â€” Ğ·Ğ´ĞµÑÑŒ Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ²Ğ¾Ñ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ°.",
    "Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€": "ğŸŒ™ <b>Ğ ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€</b>: Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹ ÑÑ€ĞµĞ´Ñƒ Ğ¸ Ğ»ÑĞ´ĞµĞ¹ â€” ÑÑ‚Ğ¾ ĞºĞ»ÑÑ‡. Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ â€” Ğ¿Ğ¾ Ğ»ÑƒĞ½Ğ½Ğ¾Ğ¼Ñƒ Ñ†Ğ¸ĞºĞ»Ñƒ."
}

PROFILE_MINI = {
    "1/3": "1/3: Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚ + Ğ¾Ğ¿Ñ‹Ñ‚ Ñ‡ĞµÑ€ĞµĞ· Â«Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ğ»-ÑƒĞ·Ğ½Ğ°Ğ»Â».",
    "1/4": "1/4: Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ + Ğ²Ğ»Ğ¸ÑĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ĞºÑ€ÑƒĞ³ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.",
    "2/4": "2/4: Ñ‚Ğ°Ğ»Ğ°Ğ½Ñ‚ Ğ² ÑƒĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¸, Ğ·Ğ¾Ğ²Ñ‘Ñ‚ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ.",
    "2/5": "2/5: Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ…, Ğ±ĞµÑ€ĞµĞ³Ğ¸ Ñ€ĞµÑÑƒÑ€Ñ.",
    "3/5": "3/5: Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸ÑˆÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ¿Ñ‹Ñ‚.",
    "3/6": "3/6: Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ğ¾Ğ².",
    "4/6": "4/6: ÑĞ¸Ğ»Ğ° Ğ² ÑĞ²ÑĞ·ÑÑ… Ğ¸ Ğ·Ñ€ĞµĞ»Ğ¾ÑÑ‚Ğ¸.",
    "4/1": "4/1: Ñ€ĞµĞ´ĞºĞ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ÑĞ²ÑĞ·ĞµĞ¹ Ğ¸ Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚Ğ°.",
    "5/1": "5/1: ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞ¹ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ….",
    "5/2": "5/2: Ğ²Ğ¾ÑÑ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ + Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ÑƒĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ.",
    "6/2": "6/2: Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ…, Ñ€ĞµÑÑƒÑ€Ñ â€” Ñ‚Ğ¸ÑˆĞ¸Ğ½Ğ°.",
    "6/3": "6/3: Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¸ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ Ğ³Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ."
}

# Ğ”Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº: Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚Ñ‹ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸ÑˆÑŒ Ğ² ./static/cards/
TYPE_CARD = {
    "Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€": "type_manifestor.jpg",
    "Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "type_generator.jpg",
    "Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "type_mg.jpg",
    "Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€": "type_projector.jpg",
    "Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€": "type_reflector.jpg",
}

PROFILE_CARD = {
    k: f"profile_{k.replace('/','-')}.jpg" for k in PROFILE_MINI.keys()
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞœĞµĞ½Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MAIN_KB = reply_kb([
    ["âœ¨ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ´Ğ¸Ğ³Ñ€Ğ°Ñ„", "ğŸ’ ĞŸĞ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚"],
    ["ğŸ¬ Ğ’Ğ¸Ğ´ĞµĞ¾ / Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ"],
    ["â„¹ï¸ Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Human Design?"],
    ["ğŸ“š Ğ Ñ‚Ğ¸Ğ¿Ğ°Ñ…", "ğŸ“– Ğ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑÑ…"],
    ["ğŸ“ Ğ¯ Ğ·Ğ½Ğ°Ñ ÑĞ²Ğ¾Ğ¹ Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ"],
    ["ğŸ’¼ ĞœĞ¾Ğ¸ ÑƒÑĞ»ÑƒĞ³Ğ¸", "ğŸ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº / Ğ³Ğ°Ğ¹Ğ´"]
])

# Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
USER_STATE = {}   # chat_id -> "await_type_profile" | "await_email" | None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ’ĞµĞ±-Ñ‡Ğ°ÑÑ‚ÑŒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/")
def health():
    return "OK"

@app.get("/hd")
def webapp_index():
    return send_from_directory("webapp", "index.html")

@app.get("/hd/<path:fname>")
def webapp_files(fname):
    return send_from_directory("webapp", fname)

@app.get("/privacy")
def privacy():
    return send_from_directory("static", "privacy.html")

# Ğ Ğ°Ğ·Ğ´Ğ°Ñ‡Ğ° Ğ¼ĞµĞ´Ğ¸Ğ°ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
@app.get("/cards/<path:fname>")
def cards(fname):
    return send_from_directory(CARDS_DIR, fname)

# Ğ£Ğ´Ğ¾Ğ±Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²ĞµĞ±Ñ…ÑƒĞº Ğ¸Ğ· Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°
@app.get("/set-webhook")
def set_webhook():
    url = f"{BASE_URL}/tg/webhook"
    r = requests.get(
        f"{TG_API}/setWebhook",
        params={"url": url, "secret_token": SECRET_TOKEN},
        timeout=10
    )
    return jsonify(r.json())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Telegram webhook
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/tg/webhook")
def webhook():
    if request.headers.get("X-Telegram-Bot-Api-Secret-Token") != SECRET_TOKEN:
        return "forbidden", 403

    upd = request.get_json(silent=True) or {}
    msg = upd.get("message") or upd.get("edited_message") or {}
    chat_id = (msg.get("chat") or {}).get("id")
    text = (msg.get("text") or "").strip()

    if not chat_id:
        return "ok"

    # /start
    if text.startswith("/start"):
        intro = (
            "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ­Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ <b>Sabina Energy</b> Ğ¿Ğ¾ Human Design.\n\n"
            "â€¢ ÑĞ´ĞµĞ»Ğ°Ğ¹ <b>Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚</b>\n"
            "â€¢ ÑƒĞ·Ğ½Ğ°Ğ¹ Ğ¾ÑĞ½Ğ¾Ğ²Ñ‹\n"
            "â€¢ Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸ Ğº <b>Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¼Ñƒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ñƒ</b>\n"
            "â€¢ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ²Ğ¸Ğ´ĞµĞ¾\n\n"
            "ĞšĞ¾Ğ³Ğ´Ğ° Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑˆÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ â€” Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ ÑÑĞ´Ğ° ÑĞ²Ğ¾Ğ¹ <b>Ñ‚Ğ¸Ğ¿</b> Ğ¸ <b>Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</b> (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Â«ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ 3/5Â»). Ğ¯ Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ âœ¨"
        )
        tg("sendMessage", chat_id=chat_id, text=intro, parse_mode="HTML", reply_markup=MAIN_KB)
        USER_STATE.pop(chat_id, None)
        return "ok"

    # ĞšĞ½Ğ¾Ğ¿ĞºĞ¸
    if text == "âœ¨ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ´Ğ¸Ğ³Ñ€Ğ°Ñ„":
        caption = (
            "ĞÑ‚ĞºÑ€Ğ¾Ğ¹ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.\n"
            "ĞšĞ¾Ğ³Ğ´Ğ° ÑƒĞ²Ğ¸Ğ´Ğ¸ÑˆÑŒ ÑĞ²Ğ¾Ğ¹ <b>Ñ‚Ğ¸Ğ¿</b> Ğ¸ <b>Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</b> â€” Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¸Ñ… ÑÑĞ´Ğ°, Ñ Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ âœ¨"
        )
        tg("sendMessage", chat_id=chat_id, text=caption, parse_mode="HTML",
           reply_markup={"inline_keyboard":[[inline_btn("ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€", url=FREE_CALC_URL)]]})
        return "ok"

    if text == "ğŸ’ ĞŸĞ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚":
        tg("sendMessage", chat_id=chat_id, text="ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚:", parse_mode="HTML",
           reply_markup={"inline_keyboard":[[inline_btn("ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¼Ñƒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñƒ", url=PAID_CALC_URL)]]})
        return "ok"

    if text == "ğŸ¬ Ğ’Ğ¸Ğ´ĞµĞ¾ / Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ":
        tg("sendMessage", chat_id=chat_id, text="ĞšĞ°Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼:", parse_mode="HTML",
           reply_markup={"inline_keyboard":[[inline_btn("Ğ¡Ğ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾", url=VIDEO_URL)]]})
        return "ok"

    if text == "â„¹ï¸ Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Human Design?":
        for p in ABOUT_HD: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        return "ok"

    if text == "ğŸ“š Ğ Ñ‚Ğ¸Ğ¿Ğ°Ñ…":
        for p in ABOUT_TYPES_SHORT: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        # Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ ÑˆĞ¿Ğ°Ñ€Ğ³Ğ°Ğ»ĞºĞ°
        for p in ABOUT_TYPES_LONG: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        return "ok"

    if text == "ğŸ“– Ğ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑÑ…":
        for p in ABOUT_PROFILES_SHORT: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        for key in ["1/3","1/4","2/4","2/5","3/5","3/6","4/6","4/1","5/1","5/2","6/2","6/3"]:
            tg("sendMessage", chat_id=chat_id, text=f"â€¢ <b>{key}</b> â€” {PROFILE_LONG[key]}", parse_mode="HTML")
        return "ok"

    if text == "ğŸ’¼ ĞœĞ¾Ğ¸ ÑƒÑĞ»ÑƒĞ³Ğ¸":
        services = (
            "ğŸ’¼ <b>ĞœĞ¾Ğ¸ ÑƒÑĞ»ÑƒĞ³Ğ¸</b>\n\n"
            "â€¢ Ğ˜Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ 90 Ğ¼Ğ¸Ğ½ÑƒÑ‚ + Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚.\n"
            "â€¢ Ğ Ğ°Ğ·Ğ±Ğ¾Ñ€ Ñ‚Ğ¸Ğ¿Ğ°, ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸, Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ° Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ.\n\n"
            "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¼Ğ½Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:"
        )
        tg("sendMessage", chat_id=chat_id, text=services, parse_mode="HTML",
           reply_markup={"inline_keyboard":[[inline_btn("ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¡Ğ°Ğ±Ğ¸Ğ½Ğµ", url="https://t.me/coachsabina")]]})
        return "ok"

    if text == "ğŸ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº / Ğ³Ğ°Ğ¹Ğ´":
        USER_STATE[chat_id] = "await_email"
        ask = "ĞÑÑ‚Ğ°Ğ²ÑŒ e-mail â€” Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ğ³Ğ°Ğ¹Ğ´ Ğ½Ğ° Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ âœ‰ï¸"
        tg("sendMessage", chat_id=chat_id, text=ask)
        return "ok"

    if text == "ğŸ“ Ğ¯ Ğ·Ğ½Ğ°Ñ ÑĞ²Ğ¾Ğ¹ Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ":
        USER_STATE[chat_id] = "await_type_profile"
        tg("sendMessage", chat_id=chat_id,
           text="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ÑĞ²Ğ¾Ğ¹ <b>Ñ‚Ğ¸Ğ¿</b> Ğ¸ <b>Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</b> Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Â«ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ 3/5Â»).",
           parse_mode="HTML")
        return "ok"

    # Ğ¡Ğ±Ğ¾Ñ€ e-mail
    if USER_STATE.get(chat_id) == "await_email":
        if email_valid(text):
            save_lead(chat_id=chat_id, email=text, source="gift")
            USER_STATE[chat_id] = None
            tg("sendMessage", chat_id=chat_id, text="Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾! Ğ“Ğ°Ğ¹Ğ´ ÑĞºĞ¾Ñ€Ğ¾ Ğ¿Ñ€Ğ¸Ğ´Ñ‘Ñ‚ Ğ½Ğ° Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ âœ¨", reply_markup=MAIN_KB)
        else:
            tg("sendMessage", chat_id=chat_id, text="Ğ¥Ğ¼Ğ¼â€¦ ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğµ Ğ½Ğ° e-mail. ĞŸÑ€Ğ¸ÑˆĞ»Ğ¸ Ğ°Ğ´Ñ€ĞµÑ Ğ²Ğ¸Ğ´Ğ° name@mail.com")
        return "ok"

    # ĞœĞ¸Ğ½Ğ¸-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    if USER_STATE.get(chat_id) == "await_type_profile" or text:
        if handle_free_text(chat_id, text):
            USER_STATE[chat_id] = None
            return "ok"

    tg("sendMessage", chat_id=chat_id, text="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸Ğ· Ğ¼ĞµĞ½Ñ ğŸ‘‡", reply_markup=MAIN_KB)
    return "ok"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ Ğ°Ğ·Ğ±Ğ¾Ñ€ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°: Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¸ Â«ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹/ÑĞµĞ»ĞµĞ·Ñ‘Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹/ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹Â»
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TYPE_PATTERNS = [
    ("Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", ["Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€","Ğ¼Ğ³","Ğ¼Ğ°Ğ½Ğ¸Ñ„. Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"]),
    ("Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", ["Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"]),
    ("Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€", ["Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€"]),
    ("Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€", ["Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€"]),
    ("Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€", ["Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€"]),
]
PROFILE_REGEX = re.compile(r"(\b[1-6][\./][1-6]\b)")

def detect_type(text: str):
    t = text.lower()
    for key, variants in TYPE_PATTERNS:
        for v in variants:
            if v in t:
                return key
    return None

def detect_profile(text: str):
    cleaned = text.lower().replace(" ", "")
    m = PROFILE_REGEX.search(cleaned)
    if not m:
        return None
    prof = m.group(1).replace(".", "/")
    return prof if prof in PROFILE_MINI else None

def detect_authority_suffix(text: str):
    s = text.lower()
    if "ÑĞ¼Ğ¾Ñ†Ğ¸" in s:     return " (ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)"
    if "ÑĞµĞ»ĞµĞ·" in s:     return " (ÑĞµĞ»ĞµĞ·Ñ‘Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹)"
    if "ÑĞ°ĞºÑ€Ğ°Ğ»" in s:    return " (ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)"
    return ""

def handle_free_text(chat_id, text):
    if not text:
        return False

    detected_type = detect_type(text)
    detected_profile = detect_profile(text)
    authority = detect_authority_suffix(text)

    # Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ»Ğ¸ â€” Ğ½Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼
    if not detected_type and not detected_profile:
        return False

    parts = []

    if detected_type:
        base = TYPE_MINI.get(detected_type, "")
        if base:
            # Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Â«ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹/ÑĞµĞ»ĞµĞ·Ñ‘Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹/ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹Â» Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº
            base = base.replace("</b>:", f"</b>{authority}:")
            parts.append(base)
            # Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ Ñ‚Ğ¸Ğ¿Ğ°
            send_photo_if_exists(chat_id, TYPE_CARD.get(detected_type, ""))

    if detected_profile:
        parts.append("ğŸ§© " + PROFILE_MINI[detected_profile])
        # ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        send_photo_if_exists(chat_id, PROFILE_CARD.get(detected_profile, ""))

    text_out = "\n\n".join(parts) + "\n\nĞ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ â€” Ğ¶Ğ¼Ğ¸ Â«ğŸ’ ĞŸĞ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Â» Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¼Ğ½Ğµ Ğ² Ğ»Ğ¸Ñ‡ĞºÑƒ."
    tg("sendMessage", chat_id=chat_id, text=text_out, parse_mode="HTML", reply_markup=MAIN_KB)

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ»Ğ¸Ğ´ (ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ²ĞµĞ±-Ñ…ÑƒĞº)
    save_lead(chat_id=chat_id, user_text=text, hd_type=detected_type, profile=detected_profile, tag="type_profile")

    return True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ»Ğ¸Ğ´Ğ° Ğ² Google Sheets (Ñ‡ĞµÑ€ĞµĞ· Apps Script / Ñ„Ğ¾Ñ€Ğ¼Ñƒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def save_lead(chat_id: int, email: str = None, user_text: str = None,
              hd_type: str = None, profile: str = None, source: str = None, tag: str = None):
    if not LEAD_WEBHOOK_URL:
        return
    payload = {
        "chat_id": chat_id,
        "username": None,
        "email": email,
        "text": user_text,
        "type": hd_type,
        "profile": profile,
        "source": source,
        "tag": tag,
        "ts": datetime.utcnow().isoformat()
    }
    try:
        requests.post(LEAD_WEBHOOK_URL, json=payload, timeout=10)
    except Exception:
        pass

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gunicorn entry
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)

app = app
