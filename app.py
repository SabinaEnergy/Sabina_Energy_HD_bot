# app.py
import os, re, json, requests
from urllib.parse import urlsplit, urlunsplit, parse_qs, urlencode
from flask import Flask, request, jsonify, send_from_directory

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ENV
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BOT_TOKEN       = os.getenv("BOT_TOKEN", "")
SECRET_TOKEN    = os.getenv("SECRET_TOKEN", "SabinaSecret")

BASE_URL        = os.getenv("BASE_URL", "https://sabina-energy-hd-bot.onrender.com")
FREE_CALC_URL   = os.getenv("FREE_CALC_URL",  "https://human-design.space/dizajn-cheloveka-raschet-karty/#/")
PAID_CALC_URL   = os.getenv("PAID_CALC_URL",  "https://human-design.space/dizajn-cheloveka-raschet-karty/#/")
LEAD_FORM_URL   = os.getenv("LEAD_FORM_URL",  "https://forms.gle/xxxx")
VIDEO_URL       = os.getenv("VIDEO_URL",      "https://t.me/your_channel/123")

TG_API = f"https://api.telegram.org/bot{BOT_TOKEN}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Flask
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = Flask(__name__, static_folder="webapp", static_url_path="/hd")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def tg(method: str, **params):
    """Call Telegram Bot API with json body."""
    try:
        r = requests.post(f"{TG_API}/{method}", json=params, timeout=10)
        return r.json()
    except Exception as e:
        return {"ok": False, "error": str(e)}

def reply_kb(button_rows):
    """Reply keyboard (persistent menu)."""
    return {
        "keyboard": button_rows,
        "resize_keyboard": True,
        "is_persistent": True
    }

def inline_btn(text, url=None, data=None):
    b = {"text": text}
    if url:  b["url"] = url
    if data: b["callback_data"] = data
    return b

def format_b(old):
    """Make **bold** words for Telegram via <b>..</b>."""
    return old.replace("**", "<b>").replace("__", "</b>")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Content (ĞºÑ€Ğ°Ñ‚ĞºĞ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ğ»Ğ°)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ABOUT_HD = [
    "âœ¨ <b>Human Design</b> â€” ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€Ğ¾ Ñ‚Ğ¾, ĞºĞ°Ğº Ğ¶Ğ¸Ñ‚ÑŒ Ğ² ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğ¸ ÑĞ¾ ÑĞ²Ğ¾ĞµĞ¹ Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´Ğ¾Ğ¹, Ğ±ĞµĞ· Ğ±Ğ¾Ñ€ÑŒĞ±Ñ‹ Ñ ÑĞ¾Ğ±Ğ¾Ğ¹.",
    "ğŸ”­ Ğ­Ñ‚Ğ¾ ÑĞ¸Ğ½Ñ‚ĞµĞ· Ğ°ÑÑ‚Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸, Ğ˜-Ğ¦Ğ·Ğ¸Ğ½, ĞšĞ°Ğ±Ğ±Ğ°Ğ»Ñ‹, Ñ‡Ğ°ĞºÑ€Ğ¾Ğ²Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸ ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ½Ğ°ÑƒĞºĞ¸ Ğ¾ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ¸Ğ½Ğ¾.",
    "ğŸ¯ Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ â€” <b>ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ¸ ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ</b>. Ğ¢Ğ°Ğº ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ»Ğ¸ÑˆĞ½ĞµĞµ Ğ½Ğ°Ğ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ Â«ÑĞ²Ğ¾Ğ¸Â» Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸."
]

ABOUT_TYPES = [
    "ğŸ“š <b>Ğ¢Ğ¸Ğ¿Ñ‹ Ğ² Human Design</b> (Ğ²ÑĞµĞ³Ğ¾ 5):",
    "â€¢ ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€ â€” Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€ÑƒĞµÑ‚. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</i>.",
    "â€¢ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ñ‚ĞºĞ»Ğ¸Ğº. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ°</i>.",
    "â€¢ ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ° â†’ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</i>.",
    "â€¢ ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€ â€” Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¸ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ</i>.",
    "â€¢ Ğ ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€ â€” Ğ·ĞµÑ€ĞºĞ°Ğ»Ğ¸Ñ‚ ÑÑ€ĞµĞ´Ñƒ. <i>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ»ÑƒĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»</i>."
]

ABOUT_PROFILES = [
    "ğŸ“– <b>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸</b> â€” ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ²ÑƒÑ… Ğ»Ğ¸Ğ½Ğ¸Ğ¹. Ğ’ÑĞµĞ³Ğ¾ 12:",
    "1/3, 1/4, 2/4, 2/5, 3/5, 3/6, 4/6, 4/1, 5/1, 5/2, 6/2, 6/3."
]

TYPE_MINI = {
    "Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€": "âš¡ï¸ <b>ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€</b>: Ğ·Ğ´ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ. Ğ¡Ğ¸Ğ»Ğ° â€” Ğ² ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ÑÑ‚Ğ°Ñ€Ñ‚Ğ°Ñ… Ğ¸ Ñ‡ĞµÑÑ‚Ğ½Ğ¾Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸.",
    "Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "ğŸ”‹ <b>Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€</b>: ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ½Ğ° Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾-Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞ¼Ñƒ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ°ĞµÑ‚ÑÑ. Ğ¡Ğ»ÑƒÑˆĞ°Ğ¹ ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Â«Ğ´Ğ°/Ğ½ĞµÑ‚Â».",
    "Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "ğŸš€ <b>ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€</b>: Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµÑˆÑŒ Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑˆÑŒ. Ğ–Ğ´Ğ¸ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ°, Ğ° Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞ¹.",
    "Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€": "ğŸ¯ <b>ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€</b>: Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ğ»ÑĞ´ĞµĞ¹ Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹. Ğ¡Ğ¸Ğ»Ğ° â€” Ğ² Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¸ Ğ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸ÑÑ….",
    "Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€": "ğŸŒ™ <b>Ğ ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€</b>: Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğº ÑÑ€ĞµĞ´Ğµ. Ğ’Ğ°Ğ¶Ğ½Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ»ÑĞ´Ğ¸ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ; ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ â€” Ğ¿Ğ¾ Ğ»ÑƒĞ½Ğ½Ğ¾Ğ¼Ñƒ Ñ†Ğ¸ĞºĞ»Ñƒ."
}

PROFILE_MINI = {
    "1/3": "1/3 Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ-ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº: ÑƒÑ‡Ğ¸ÑˆÑŒÑÑ Ñ‡ĞµÑ€ĞµĞ· ÑĞºÑĞ¿ĞµÑ€Ğ¸Ğ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¾Ğ¿Ñ‹Ñ‚.",
    "1/4": "1/4 Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ-ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚: Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚ + ÑĞ²ÑĞ·Ğ¸, Ğ²Ğ»Ğ¸ÑĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ.",
    "2/4": "2/4 ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº-ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚: Ñ‚Ğ°Ğ»Ğ°Ğ½Ñ‚ Ğ² ÑƒĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¸, Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ Ğ¾Ñ‚ Ğ»ÑĞ´ĞµĞ¹.",
    "2/5": "2/5 ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº-Ğ•Ñ€ĞµÑ‚Ğ¸Ğº: Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ…, Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ±ĞµÑ€ĞµÑ‡ÑŒ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ.",
    "3/5": "3/5 ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº-Ğ•Ñ€ĞµÑ‚Ğ¸Ğº: Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµÑˆÑŒ, Ğ¿Ğ°Ğ´Ğ°ĞµÑˆÑŒ, Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµÑˆÑŒÑÑ â€” Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸ÑˆÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.",
    "3/6": "3/6 ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº-Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: Ğ¿ÑƒÑ‚ÑŒ Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğ¼ Ğº Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚Ğ¸, Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ 30/50.",
    "4/6": "4/6 ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚-Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: Ğ²Ğ»Ğ¸ÑĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ĞºÑ€ÑƒĞ³ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ; ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ¾Ğ¼.",
    "4/1": "4/1 ĞĞ¿Ğ¿Ğ¾Ñ€Ñ‚ÑƒĞ½Ğ¸ÑÑ‚-Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: Ñ€ĞµĞ´ĞºĞ¸Ğ¹ Ğ¼Ğ¾ÑÑ‚ â€” Ğ¸ ÑĞ²ÑĞ·Ğ¸, Ğ¸ Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.",
    "5/1": "5/1 Ğ•Ñ€ĞµÑ‚Ğ¸Ğº-Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³-Ñ€ĞµÑˆĞ°Ñ‚ĞµĞ»ÑŒ; Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğ¹.",
    "5/2": "5/2 Ğ•Ñ€ĞµÑ‚Ğ¸Ğº-ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº: Ğ²Ğ¾ÑÑ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ + Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ÑƒĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ.",
    "6/2": "6/2 Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ-ĞÑ‚ÑˆĞµĞ»ÑŒĞ½Ğ¸Ğº: Ğ²Ñ€Ğ¾Ğ¶Ğ´Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€; Ñ‚Ñ€Ğ¸ ÑÑ‚Ğ°Ğ¿Ğ° Ğ¶Ğ¸Ğ·Ğ½Ğ¸, Ğ¼Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ·ĞµÑ€Ñ†Ğ°Ğ½Ğ¸Ñ.",
    "6/3": "6/3 Ğ Ğ¾Ğ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ-ĞœÑƒÑ‡ĞµĞ½Ğ¸Ğº: Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¸ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ; Ğ³Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ â€” ÑÑƒĞ¿ĞµÑ€ÑĞ¸Ğ»Ğ°."
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞœĞµĞ½Ñ (reply keyboard)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MAIN_KB = reply_kb([
    ["âœ¨ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ´Ğ¸Ğ³Ñ€Ğ°Ñ„", "ğŸ’ ĞŸĞ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚"],
    ["ğŸ¬ Ğ’Ğ¸Ğ´ĞµĞ¾ / Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ"],
    ["â„¹ï¸ Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Human Design?"],
    ["ğŸ“š Ğ Ñ‚Ğ¸Ğ¿Ğ°Ñ…", "ğŸ“– Ğ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑÑ…"],
    ["ğŸ“ Ğ¯ Ğ·Ğ½Ğ°Ñ ÑĞ²Ğ¾Ğ¹ Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ"],
    ["ğŸ’¼ ĞœĞ¾Ğ¸ ÑƒÑĞ»ÑƒĞ³Ğ¸", "ğŸ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº / Ğ³Ğ°Ğ¹Ğ´"]
])

# ĞŸĞ°Ğ¼ÑÑ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Â«Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸ Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒÂ»
USER_STATE = {}   # chat_id -> "await_type_profile" | None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ’ĞµĞ±-Ñ‡Ğ°ÑÑ‚ÑŒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/")
def health():
    return "OK"

@app.get("/privacy")
def privacy():
    return send_from_directory("static", "privacy.html")

@app.get("/hd")
def webapp_index():
    return send_from_directory("webapp", "index.html")

@app.get("/hd/<path:fname>")
def webapp_files(fname):
    return send_from_directory("webapp", fname)

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° (ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ Ğ´ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¸Ğ· Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°)
@app.get("/set-webhook")
def set_webhook():
    url = f"{BASE_URL}/tg/webhook"
    r = requests.get(
        f"{TG_API}/setWebhook",
        params={"url": url, "secret_token": SECRET_TOKEN},
        timeout=10
    )
    return jsonify(r.json())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Telegram webhook
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/tg/webhook")
def webhook():
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Telegram
    if request.headers.get("X-Telegram-Bot-Api-Secret-Token") != SECRET_TOKEN:
        return "forbidden", 403

    upd = request.get_json(silent=True) or {}
    msg = upd.get("message") or upd.get("edited_message") or {}
    chat = msg.get("chat") or {}
    chat_id = chat.get("id")
    text = (msg.get("text") or "").strip()

    if not chat_id:
        return "ok"

    # /start
    if text.startswith("/start"):
        intro = (
            "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ­Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ <b>Sabina Energy</b> Ğ¿Ğ¾ Human Design.\n\n"
            "Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾:\n"
            "â€¢ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ <b>Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚</b>,\n"
            "â€¢ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ¾ÑĞ½Ğ¾Ğ²Ñ‹,\n"
            "â€¢ Ğ¿ĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº <b>Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¼Ñƒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ñƒ</b>,\n"
            "â€¢ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾.\n\n"
            "ĞšĞ¾Ğ³Ğ´Ğ° Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑˆÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ â€” Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ ÑÑĞ´Ğ° Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ ÑĞ²Ğ¾Ğ¹ <b>Ñ‚Ğ¸Ğ¿</b> Ğ¸ <b>Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</b>. "
            "Ğ¯ Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ âœ¨"
        )
        tg("sendMessage", chat_id=chat_id, text=intro, parse_mode="HTML", reply_markup=MAIN_KB)
        USER_STATE.pop(chat_id, None)
        return "ok"

    # ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ½Ñ
    if text == "âœ¨ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ´Ğ¸Ğ³Ñ€Ğ°Ñ„":
        caption = (
            "ĞÑ‚ĞºÑ€Ğ¾Ğ¹ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.\n"
            "ĞšĞ¾Ğ³Ğ´Ğ° ÑƒĞ²Ğ¸Ğ´Ğ¸ÑˆÑŒ ÑĞ²Ğ¾Ğ¹ <b>Ñ‚Ğ¸Ğ¿</b> Ğ¸ <b>Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</b> â€” Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ ÑÑĞ´Ğ° Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¸Ñ…, Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ âœ¨"
        )
        tg("sendMessage",
           chat_id=chat_id,
           text=caption,
           parse_mode="HTML",
           reply_markup={"inline_keyboard":[[inline_btn("ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€", url=FREE_CALC_URL)]]})
        USER_STATE[chat_id] = None
        return "ok"

    if text == "ğŸ’ ĞŸĞ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚":
        tg("sendMessage",
           chat_id=chat_id,
           text="ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ±ĞµĞ· Ğ¼Ğ¾ĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ¸Ñ:",
           reply_markup={"inline_keyboard":[[inline_btn("ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¼Ñƒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñƒ", url=PAID_CALC_URL)]]})
        return "ok"

    if text == "ğŸ¬ Ğ’Ğ¸Ğ´ĞµĞ¾ / Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ":
        tg("sendMessage",
           chat_id=chat_id,
           text="ĞšĞ°Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¸ Ğ³Ğ´Ğµ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:",
           reply_markup={"inline_keyboard":[[inline_btn("Ğ¡Ğ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾", url=VIDEO_URL)]]})
        return "ok"

    if text == "â„¹ï¸ Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Human Design?":
        for p in ABOUT_HD: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        return "ok"

    if text == "ğŸ“š Ğ Ñ‚Ğ¸Ğ¿Ğ°Ñ…":
        for p in ABOUT_TYPES: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        return "ok"

    if text == "ğŸ“– Ğ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑÑ…":
        for p in ABOUT_PROFILES: tg("sendMessage", chat_id=chat_id, text=p, parse_mode="HTML")
        return "ok"

    if text == "ğŸ’¼ ĞœĞ¾Ğ¸ ÑƒÑĞ»ÑƒĞ³Ğ¸":
        services = (
            "ğŸ’¼ <b>ĞœĞ¾Ğ¸ ÑƒÑĞ»ÑƒĞ³Ğ¸</b>\n\n"
            "â€¢ Ğ˜Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ 90 Ğ¼Ğ¸Ğ½ÑƒÑ‚ + Ğ¿Ğ¸ÑÑŒĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚.\n"
            "â€¢ Ğ Ğ°Ğ·Ğ±Ğ¾Ñ€ Ñ‚Ğ¸Ğ¿Ğ°, ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸, Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ° Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ.\n"
            "â€¢ ĞÑ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²Ğ°ÑˆĞ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹.\n\n"
            "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¼Ğ½Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ â€” Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ğ¼ÑÑ Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸:"
        )
        tg("sendMessage", chat_id=chat_id, text=services, parse_mode="HTML",
           reply_markup={"inline_keyboard":[[inline_btn("ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¡Ğ°Ğ±Ğ¸Ğ½Ğµ", url="https://t.me/coachsabina")]]})
        return "ok"

    if text == "ğŸ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº / Ğ³Ğ°Ğ¹Ğ´":
        lead = (
            "ğŸ Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸-Ğ³Ğ°Ğ¹Ğ´? ĞÑÑ‚Ğ°Ğ²ÑŒ e-mail Ğ¿Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞµ Ğ½Ğ¸Ğ¶Ğµ, Ğ¸ Ñ Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº Ğ½Ğ° Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ."
        )
        tg("sendMessage", chat_id=chat_id, text=lead,
           reply_markup={"inline_keyboard":[[inline_btn("ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ e-mail", url=LEAD_FORM_URL)]]})
        return "ok"

    if text == "ğŸ“ Ğ¯ Ğ·Ğ½Ğ°Ñ ÑĞ²Ğ¾Ğ¹ Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ":
        prompt = (
            "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ ÑĞ²Ğ¾Ğ¹ <b>Ñ‚Ğ¸Ğ¿</b> Ğ¸ <b>Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</b>.\n"
            "ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: <i>ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ 3/5</i> Ğ¸Ğ»Ğ¸ <i>Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€ 4.1</i>."
        )
        USER_STATE[chat_id] = "await_type_profile"
        tg("sendMessage", chat_id=chat_id, text=prompt, parse_mode="HTML")
        return "ok"

    # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ğ» ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ñ‚ÑŒ Ñ‚Ğ¸Ğ¿/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
    if USER_STATE.get(chat_id) == "await_type_profile" or text:
        handled = handle_free_text(chat_id, text)
        if handled:
            USER_STATE[chat_id] = None
            return "ok"

    # Ğ•ÑĞ»Ğ¸ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¾ â€” Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµĞ¼ Ğ¼ĞµĞ½Ñ
    tg("sendMessage", chat_id=chat_id, text="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸Ğ· Ğ¼ĞµĞ½Ñ Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡", reply_markup=MAIN_KB)
    return "ok"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¸Ğ¿Ğ°/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¸ Ğ¼Ğ¸Ğ½Ğ¸-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TYPE_PATTERNS = [
    ("Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", ["Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€","Ğ¼Ğ³","Ğ¼Ğ°Ğ½Ğ¸Ñ„. Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"]),
    ("Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", ["Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"]),
    ("Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€", ["Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ¾Ñ€"]),
    ("Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€", ["Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€"]),
    ("Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€", ["Ñ€ĞµÑ„Ğ»ĞµĞºÑ‚Ğ¾Ñ€"]),
]

PROFILE_REGEX = re.compile(r"(\b[1-6][\./][1-6]\b)")

def detect_type(text: str):
    t = text.lower()
    for key, variants in TYPE_PATTERNS:
        for v in variants:
            if v in t:
                return key
    return None

def detect_profile(text: str):
    m = PROFILE_REGEX.search(text.replace(" ", ""))
    if not m:
        return None
    prof = m.group(1).replace(".", "/")
    return prof if prof in PROFILE_MINI else None

def handle_free_text(chat_id, text):
    if not text:
        return False

    t = detect_type(text)
    p = detect_profile(text)

    if not t and not p:
        return False  # Ğ½Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ â€” Ğ¿ÑƒÑÑ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ¼ĞµĞ½Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ

    parts = []
    if t:
        # ÑƒĞ»Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Â«ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹/ÑĞµĞ»ĞµĞ·Ñ‘Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹/ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹Â» Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğº Ñ‚Ğ¸Ğ¿Ñƒ
        authority_hint = ""
        if "ÑĞ¼Ğ¾Ñ†" in text.lower(): authority_hint = " (ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)"
        if "ÑĞµĞ»ĞµĞ·" in text.lower(): authority_hint = " (ÑĞµĞ»ĞµĞ·Ñ‘Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹)"
        if "ÑĞ°ĞºÑ€Ğ°Ğ»" in text.lower(): authority_hint = " (ÑĞ°ĞºÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)"
        parts.append(TYPE_MINI.get(t, "").replace("</b>:", f"</b>{authority_hint}:"))

    if p:
        parts.append("ğŸ§© " + PROFILE_MINI[p])

    if parts:
        msg = "\n\n".join(parts) + "\n\nĞ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ â€” Ğ¶Ğ¼Ğ¸ Â«ğŸ’ ĞŸĞ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Â» Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¼Ğ½Ğµ Ğ² Ğ»Ğ¸Ñ‡ĞºÑƒ."
        tg("sendMessage", chat_id=chat_id, text=msg, parse_mode="HTML", reply_markup=MAIN_KB)
        return True

    return False

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gunicorn entry
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    # Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
    app.run(host="0.0.0.0", port=8000)

# Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ gunicorn Ğ²Ğ¸Ğ´ĞµĞ» Ğ¾Ğ±ÑŠĞµĞºÑ‚ app
app = app
