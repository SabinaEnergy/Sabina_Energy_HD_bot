<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Рассчёт бодиграфа — Sabina Energy</title>

  <!-- Красивые шрифты и твой CSS (если есть) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Скрипт Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* Небольшие базовые стили (на случай, если style.css пустой) */
    :root{--bg:#0d0d12;--card:#151723;--text:#f2f3f7;--muted:#98a0b3;--primary:#ff5e78;--accent:#ffd66e}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Montserrat',system-ui,Arial,sans-serif;background:#0d0d12;color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:min(720px,100%);background:#151723;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    h1{margin:0 0 16px;font-size:26px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{display:flex;flex-direction:column;gap:6px;font-weight:600}
    label.full{grid-column:1/-1}
    input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0f111a;color:#fff;font-size:16px;outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,214,110,.2)}
    button{margin-top:6px;background:linear-gradient(135deg,var(--primary),#ff6a00);border:none;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Рассчёт бодиграфа</h1>

    <form id="hdForm" autocomplete="off">
      <div class="grid">
        <label>
          Имя
          <input type="text" id="name" name="name" placeholder="Например, Сабина" required>
        </label>

        <label>
          Пол
          <select id="gender" name="gender" required>
            <option value="">Выберите…</option>
            <option value="Жен">Жен</option>
            <option value="Муж">Муж</option>
          </select>
        </label>

        <label>
          Дата рождения
          <input type="date" id="date" name="date" required>
        </label>

        <label>
          Время рождения
          <input type="time" id="time" name="time" required>
        </label>

        <label class="full">
          Город рождения
          <input type="text" id="city" name="city" placeholder="Начните вводить…" list="citylist" required>
          <datalist id="citylist"></datalist>
          <small class="hint">Подсказки подтягиваются из OpenStreetMap</small>
        </label>
      </div>

      <button type="submit" id="submitBtn">Рассчитать</button>
    </form>
  </div>

  <!-- Передаём реф-ссылку с бэка во фронт -->
  <script>window.REDIRECT_BASE="{{ redirect_base }}";</script>

  <script>
  (function () {
    // Раскрываем WebApp, если открыто внутри Telegram
    const tg = window.Telegram?.WebApp;
    if (tg) { try { tg.expand(); tg.MainButton && tg.MainButton.hide(); } catch(_) {} }

    const form = document.getElementById('hdForm');
    const cityInput = document.getElementById('city');
    const datalist = document.getElementById('citylist');
    const submitBtn = document.getElementById('submitBtn');

    // --- Автоподсказки городов (Nominatim OpenStreetMap) ---
    let cityTimer = null;
    cityInput.addEventListener('input', () => {
      const q = cityInput.value.trim();
      if (q.length < 3) { datalist.innerHTML = ''; return; }

      clearTimeout(cityTimer);
      cityTimer = setTimeout(async () => {
        try {
          const resp = await fetch(
            'https://nominatim.openstreetmap.org/search?format=json&accept-language=ru&q=' + encodeURIComponent(q),
            { headers: { 'User-Agent': 'SabinaEnergyHD/1.0' } }
          );
          const data = await resp.json();
          datalist.innerHTML = data.slice(0, 7).map(item => {
            const city = item.display_name.split(',')[0];
            return `<option value="${city}">`;
          }).join('');
        } catch (e) { console.log('city suggest error', e); }
      }, 350);
    });

    const FIXED_UTM = { utm_source:'telegram', utm_medium:'bot', utm_campaign:'sabina_hd_bot' };

    function buildRedirectUrl(base, payload) {
      try {
        const url = new URL(base);
        // UTM по умолчанию (если нет)
        Object.entries(FIXED_UTM).forEach(([k,v])=>{
          if (!url.searchParams.has(k)) url.searchParams.set(k, v);
        });
        // Параметры формы
        Object.entries(payload).forEach(([k,v])=>{
          if (v && String(v).trim()) url.searchParams.set(k, String(v).trim());
        });
        return url.toString();
      } catch(e) {
        return base;
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const payload = {
        name:   document.getElementById('name').value.trim(),
        gender: document.getElementById('gender').value,
        date:   document.getElementById('date').value,
        time:   document.getElementById('time').value,
        city:   document.getElementById('city').value.trim()
      };

      // Простая валидация
      if (!payload.name || !payload.gender || !payload.date || !payload.time || !payload.city) {
        alert('Заполни, пожалуйста, все поля.');
        return;
      }

      submitBtn.disabled = true; submitBtn.textContent = 'Отправляем…';

      try {
        // Если открыто в Telegram → отправляем в бота
        if (tg && tg.sendData) {
          tg.sendData(JSON.stringify(payload));
          setTimeout(()=> tg.close && tg.close(), 600);
        } else {
          // Если открыто в браузере → сразу редиректим по реф-ссылке
          const base = window.REDIRECT_BASE || 'https://human-design.space?rave=7366406054640513';
          const link = buildRedirectUrl(base, payload);
          window.location.href = link; // или window.open(link, '_blank')
        }
      } catch (err) {
        console.error(err);
        alert('Не удалось отправить. Попробуй ещё раз.');
        submitBtn.disabled = false; submitBtn.textContent = 'Рассчитать';
      }
    });
  })();
  </script>
</body>
</html>
